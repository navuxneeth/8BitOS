<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>8BitOS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #2b0f54;
      --win-bg: #c2c3c7;
      --win-header: #001a6e;
      --text: #000;
      --accent: #ffcc00;
      --icon-hover: rgba(255, 255, 255, 0.15);
      --taskbar: #d0d0d0;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Press Start 2P', cursive;
      overflow: hidden;
      height: 100vh;
      cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAPCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVR4nO2RsQ3CMAhFX3YgB0AHYAViBXqDXIDcAFHkEzgEagdxAbFgTI1lQpOxLbaOunf7Oe+XwhFKa4zmpRmJmdBW6efcCs5DBY+1+ChDs0M1MP5s4uNuV5xMfgqtVZwA9AB/pEf8AmImOeQr1FKvW5Hv+g56oS+3oTloU+P0LLKSSp0ZCEUj3FxBHL3hG57g0lcrP6jVJsHkCKCUH54Tju/7Qe1iIzAOAAAAAElFTkSuQmCC') 0 0, auto;
    }

    .scanlines {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.05), rgba(0,255,0,0.05), rgba(0,0,255,0.05));
      background-size: 100% 4px, 6px 100%;
      z-index: 1200;
      mix-blend-mode: multiply;
      opacity: 0.6;
    }

    /* Preloader / Boot */
    #preloader {
      position: fixed;
      inset: 0;
      background: #000;
      color: #33ff00;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 16px;
      z-index: 1300;
      padding: 24px;
    }

    #preloader .logo {
      font-size: 18px;
      text-shadow: 0 0 8px #33ff00;
    }

    #progress-wrap {
      width: min(420px, 90vw);
      border: 2px solid #33ff00;
      padding: 4px;
    }

    #progress-bar {
      height: 14px;
      background: #104d00;
      width: 0%;
      transition: width 0.2s linear;
    }

    #boot-log {
      width: min(500px, 94vw);
      max-height: 220px;
      overflow: auto;
      background: #050505;
      border: 1px solid #104d00;
      padding: 8px;
      font-size: 11px;
      line-height: 1.6;
    }

    /* Desktop */
    #desktop {
      display: none;
      position: relative;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      background-image: radial-gradient(#442166 1px, transparent 1px);
      background-size: 6px 6px;
      overflow: hidden;
      padding-bottom: 44px;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
      gap: 12px;
      padding: 16px;
      max-width: 1280px;
    }

    .icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .icon:hover {
      background: var(--icon-hover);
      transform: translateY(-2px);
    }

    .icon-img {
      width: 54px;
      height: 54px;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 4px 4px 0 #000;
      display: grid;
      place-items: center;
      font-size: 22px;
      color: #000;
      image-rendering: pixelated;
    }

    .icon-label {
      font-size: 10px;
      text-align: center;
      padding: 4px 6px;
      background: rgba(0,0,0,0.6);
      border-radius: 6px;
      width: 100%;
    }

    /* Windows */
    .window {
      position: absolute;
      background: var(--win-bg);
      border: 2px solid #000;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.45);
      min-width: 280px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .title-bar {
      background: var(--win-header);
      color: #fff;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      font-size: 12px;
    }

    .title-bar-controls {
      display: flex;
      gap: 4px;
    }

    .title-bar-controls button {
      width: 22px;
      height: 22px;
      border: 2px solid #fff;
      border-bottom-color: #404040;
      border-right-color: #404040;
      background: var(--win-bg);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }

    .title-bar-controls button:active {
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
    }

    .window-content {
      padding: 12px;
      font-size: 12px;
      color: var(--text);
      background: var(--win-bg);
      flex: 1;
      overflow: auto;
    }

    /* Taskbar */
    #taskbar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 44px;
      background: var(--taskbar);
      border-top: 2px solid #fff;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 6px;
      z-index: 1100;
    }

    #start-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 12px;
      background: var(--win-bg);
      border: 2px solid #fff;
      border-bottom-color: #404040;
      border-right-color: #404040;
      cursor: pointer;
    }

    #start-btn:active {
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
      background: #d4d4d4;
    }

    #clock {
      margin-left: auto;
      font-size: 11px;
      padding: 6px 12px;
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
      background: #a0a0a0;
    }

    #start-menu {
      position: absolute;
      bottom: 48px;
      left: 6px;
      width: 220px;
      background: var(--win-bg);
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
      display: none;
      padding: 8px;
      z-index: 1150;
    }

    #start-menu h4 {
      margin: 4px 0 10px 0;
      font-size: 12px;
    }

    #start-menu .menu-item {
      font-size: 11px;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: #fff;
      border: 2px solid #000;
      cursor: pointer;
    }

    #start-menu .menu-item:hover { background: #d4d4d4; }

    /* Apps */
    textarea.app-notes {
      width: 100%;
      height: 220px;
      font-family: inherit;
      font-size: 11px;
      background: #fff;
      border: 2px inset #d0d0d0;
      resize: vertical;
    }

    .paint-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #paint-canvas {
      border: 2px solid #000;
      background: #fff;
      image-rendering: pixelated;
      width: 100%;
      max-width: 520px;
      height: 320px;
      touch-action: none;
      background-size: 16px 16px;
      background-position: 0 0;
    }

    #paint-canvas.grid-on {
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.08) 1px, transparent 1px);
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }

    .gallery-grid img {
      width: 100%;
      border: 2px solid #000;
      image-rendering: pixelated;
      cursor: pointer;
      background: #fff;
    }

    .theme-pill {
      display: inline-block;
      padding: 6px 8px;
      margin: 4px;
      border: 2px solid #000;
      cursor: pointer;
      background: #fff;
      font-size: 10px;
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .calc-grid button {
      padding: 10px;
      font-family: inherit;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
    }

    .music-player audio { width: 100%; }

    @media (max-width: 700px) {
      .window {
        width: 90vw !important;
        left: 5vw !important;
        top: 10vh !important;
      }
      #desktop { padding-bottom: 52px; }
      #taskbar { height: 52px; }
      .icon-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); }
      .icon-img { width: 48px; height: 48px; }
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>

  <div id="preloader">
    <div class="logo">8BitOS Bootloader</div>
    <div id="progress-wrap"><div id="progress-bar"></div></div>
    <div id="boot-status">Loading core services...</div>
    <div id="boot-log"></div>
  </div>

  <div id="desktop">
    <div class="icon-grid">
      <div class="icon" data-app="sys">
        <div class="icon-img">?</div>
        <div class="icon-label">SYSTEM</div>
      </div>
      <div class="icon" data-app="notes">
        <div class="icon-img">A</div>
        <div class="icon-label">NOTES</div>
      </div>
      <div class="icon" data-app="paint">
        <div class="icon-img">üé®</div>
        <div class="icon-label">PAINT</div>
      </div>
      <div class="icon" data-app="todo">
        <div class="icon-img">‚òëÔ∏è</div>
        <div class="icon-label">TODO</div>
      </div>
      <div class="icon" data-app="clock">
        <div class="icon-img">‚è∞</div>
        <div class="icon-label">CLOCK</div>
      </div>
      <div class="icon" data-app="browser">
        <div class="icon-img">üåê</div>
        <div class="icon-label">BROWSER</div>
      </div>
      <div class="icon" data-app="html-edit">
        <div class="icon-img"><> </div>
        <div class="icon-label">HTML EDIT</div>
      </div>
      <div class="icon" data-app="html-preview">
        <div class="icon-img">üëÅÔ∏è</div>
        <div class="icon-label">HTML PREV</div>
      </div>
      <div class="icon" data-app="terminal">
        <div class="icon-img">></div>
        <div class="icon-label">TERMINAL</div>
      </div>
      <div class="icon" data-app="weather">
        <div class="icon-img">‚òÄÔ∏è</div>
        <div class="icon-label">WEATHER</div>
      </div>
      <div class="icon" data-app="email">
        <div class="icon-img">‚úâÔ∏è</div>
        <div class="icon-label">MAIL</div>
      </div>
      <div class="icon" data-app="chat">
        <div class="icon-img">üí¨</div>
        <div class="icon-label">CHAT</div>
      </div>
      <div class="icon" data-app="game">
        <div class="icon-img">üéÆ</div>
        <div class="icon-label">GAME</div>
      </div>
      <div class="icon" data-app="mines">
        <div class="icon-img">üí£</div>
        <div class="icon-label">MINES</div>
      </div>
      <div class="icon" data-app="synth">
        <div class="icon-img">üéπ</div>
        <div class="icon-label">SYNTH</div>
      </div>
      <div class="icon" data-app="timer">
        <div class="icon-img">‚è±Ô∏è</div>
        <div class="icon-label">TIMER</div>
      </div>
      <div class="icon" data-app="converter">
        <div class="icon-img">‚áÜ</div>
        <div class="icon-label">CONVERT</div>
      </div>
      <div class="icon" data-app="calendar">
        <div class="icon-img">üìÖ</div>
        <div class="icon-label">CALENDAR</div>
      </div>
      <div class="icon" data-app="files">
        <div class="icon-img">üìÇ</div>
        <div class="icon-label">FILES</div>
      </div>
      <div class="icon" data-app="reader">
        <div class="icon-img">üìñ</div>
        <div class="icon-label">READER</div>
      </div>
      <div class="icon" data-app="music-mp3">
        <div class="icon-img">‚ô´</div>
        <div class="icon-label">MP3</div>
      </div>
      <div class="icon" data-app="pixelpad">
        <div class="icon-img">üß©</div>
        <div class="icon-label">PIXELPAD</div>
      </div>
      <div class="icon" data-app="news">
        <div class="icon-img">üì∞</div>
        <div class="icon-label">NEWS</div>
      </div>
      <div class="icon" data-app="camera">
        <div class="icon-img">üì∑</div>
        <div class="icon-label">CAMERA</div>
      </div>
      <div class="icon" data-app="gallery">
        <div class="icon-img">üñºÔ∏è</div>
        <div class="icon-label">GALLERY</div>
      </div>
      <div class="icon" data-app="calculator">
        <div class="icon-img">Ôºã</div>
        <div class="icon-label">CALC</div>
      </div>
      <div class="icon" data-app="music">
        <div class="icon-img">‚ô™</div>
        <div class="icon-label">MUSIC</div>
      </div>
      <div class="icon" data-app="radio">
        <div class="icon-img">üìª</div>
        <div class="icon-label">RADIO</div>
      </div>
      <div class="icon" data-app="themes">
        <div class="icon-img">‚öôÔ∏è</div>
        <div class="icon-label">THEMES</div>
      </div>
    </div>

    <div id="taskbar">
      <button id="start-btn"><span style="color:red">8</span><span>Bit</span></button>
      <div id="clock">00:00</div>
    </div>

    <div id="start-menu">
      <h4>Applications</h4>
      <div class="menu-item" data-app="sys">System Info</div>
      <div class="menu-item" data-app="notes">Notepad</div>
      <div class="menu-item" data-app="paint">MS Paint Clone</div>
      <div class="menu-item" data-app="gallery">Gallery Folder</div>
      <div class="menu-item" data-app="calculator">Calculator</div>
      <div class="menu-item" data-app="music">Music Player</div>
      <div class="menu-item" data-app="themes">Theme Switcher</div>
      <div class="menu-item" data-app="todo">Todo List</div>
      <div class="menu-item" data-app="clock">Clock</div>
      <div class="menu-item" data-app="browser">Mini Browser</div>
      <div class="menu-item" data-app="html-edit">HTML Editor</div>
      <div class="menu-item" data-app="html-preview">HTML Preview</div>
      <div class="menu-item" data-app="terminal">Terminal</div>
      <div class="menu-item" data-app="weather">Weather</div>
      <div class="menu-item" data-app="email">Email</div>
      <div class="menu-item" data-app="chat">Chat</div>
      <div class="menu-item" data-app="game">Snake Game</div>
      <div class="menu-item" data-app="mines">Mines</div>
      <div class="menu-item" data-app="synth">Synth</div>
      <div class="menu-item" data-app="timer">Timer</div>
      <div class="menu-item" data-app="converter">Unit Converter</div>
      <div class="menu-item" data-app="calendar">Calendar</div>
      <div class="menu-item" data-app="files">Files</div>
      <div class="menu-item" data-app="reader">Reader</div>
      <div class="menu-item" data-app="music-mp3">MP3 Deck</div>
      <div class="menu-item" data-app="pixelpad">PixelPad</div>
      <div class="menu-item" data-app="news">News</div>
      <div class="menu-item" data-app="camera">Camera</div>
      <div class="menu-item" data-app="radio">Radio</div>
    </div>
  </div>

  <script>
    const desktop = document.getElementById('desktop');
    const startBtn = document.getElementById('start-btn');
    const startMenu = document.getElementById('start-menu');
    const clockEl = document.getElementById('clock');
    let zIndexTop = 200;

    // --- Audio ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function blip(freq = 640) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = freq;
      gain.gain.value = 0.05;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => { osc.stop(); }, 120);
    }

    // --- Bootloader ---
    const bootSteps = [
      'Initializing 8Bit Kernel...',
      'Checking memory banks...',
      'Mounting /gallery drive...',
      'Loading desktop assets...',
      'Preparing audio subsystem...',
      'Starting window manager...',
      'Finalizing...'
    ];

    function runBoot() {
      const bar = document.getElementById('progress-bar');
      const log = document.getElementById('boot-log');
      const status = document.getElementById('boot-status');
      let progress = 0;
      let step = 0;

      const timer = setInterval(() => {
        progress += Math.random() * 18;
        bar.style.width = Math.min(progress, 100) + '%';
        if (step < bootSteps.length) {
          const row = document.createElement('div');
          row.textContent = '> ' + bootSteps[step];
          log.appendChild(row);
          log.scrollTop = log.scrollHeight;
          status.textContent = bootSteps[step];
          blip(520 + step * 30);
          step++;
        }
        if (progress >= 100) {
          clearInterval(timer);
          setTimeout(() => {
            document.getElementById('preloader').style.display = 'none';
            desktop.style.display = 'block';
            blip(880);
          }, 400);
        }
      }, 320);
    }

    // --- Clock ---
    function tickClock() {
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(tickClock, 1000);
    tickClock();

    // --- Start Menu ---
    startBtn.addEventListener('click', () => {
      blip();
      startMenu.style.display = startMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!startMenu.contains(e.target) && e.target !== startBtn) {
        startMenu.style.display = 'none';
      }
    });

    // --- Window Manager ---
    function createWindow(title, contentHTML, width = 360, height = 260) {
      const win = document.createElement('div');
      win.className = 'window';
      win.style.width = width + 'px';
      win.style.height = height + 'px';
      win.style.left = (40 + Math.random() * 120) + 'px';
      win.style.top = (40 + Math.random() * 70) + 'px';
      win.style.zIndex = ++zIndexTop;
      win.innerHTML = `
        <div class="title-bar" onmousedown="dragStart(event, this.parentNode)">
          <span>${title}</span>
          <div class="title-bar-controls">
            <button aria-label="minimize">_</button>
            <button aria-label="close" onclick="this.closest('.window').remove()">X</button>
          </div>
        </div>
        <div class="window-content">${contentHTML}</div>
      `;
      win.addEventListener('mousedown', () => win.style.zIndex = ++zIndexTop);
      desktop.appendChild(win);
      return win;
    }

    // --- Dragging ---
    let dragWin = null;
    let offsetX = 0, offsetY = 0;
    function dragStart(e, win) {
      dragWin = win;
      offsetX = e.clientX - win.offsetLeft;
      offsetY = e.clientY - win.offsetTop;
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('mouseup', dragEnd);
    }
    function dragMove(e) {
      if (!dragWin) return;
      dragWin.style.left = (e.clientX - offsetX) + 'px';
      dragWin.style.top = (e.clientY - offsetY) + 'px';
    }
    function dragEnd() {
      dragWin = null;
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);
    }
    window.dragStart = dragStart; // expose for inline handler

    // --- Apps ---
    const themes = {
      classic: { bg: '#2b0f54', win: '#c2c3c7', head: '#001a6e', task: '#d0d0d0', icon: 'rgba(255,255,255,0.15)' },
      neon: { bg: '#090912', win: '#0f111a', head: '#11c5ff', task: '#0c0f1a', icon: 'rgba(17,197,255,0.2)' },
      sunset: { bg: '#2d0b1a', win: '#f8d9c6', head: '#c5163a', task: '#f1c0a0', icon: 'rgba(197,22,58,0.2)' },
      ocean: { bg: '#032b44', win: '#d8f1ff', head: '#0b7fab', task: '#a5d7f2', icon: 'rgba(11,127,171,0.2)' },
      forest: { bg: '#0f2d1e', win: '#daf0da', head: '#2f7b4b', task: '#b5d9b7', icon: 'rgba(47,123,75,0.2)' },
      candy: { bg: '#4d1135', win: '#ffe3f0', head: '#ff5ba8', task: '#ffc9e0', icon: 'rgba(255,91,168,0.25)' },
      desert: { bg: '#3a2010', win: '#f6e2c4', head: '#c2853a', task: '#e9c58f', icon: 'rgba(194,133,58,0.22)' },
      arctic: { bg: '#0a2236', win: '#e9f5ff', head: '#4aa0d5', task: '#c7e6fb', icon: 'rgba(74,160,213,0.22)' },
      grayscale: { bg: '#111', win: '#e5e5e5', head: '#333', task: '#ccc', icon: 'rgba(255,255,255,0.12)' },
      matrix: { bg: '#001000', win: '#0a1a0a', head: '#00ff66', task: '#042b0b', icon: 'rgba(0,255,102,0.18)' },
      vapor: { bg: '#160d2e', win: '#f1d7ff', head: '#7b5cf0', task: '#d0b5ff', icon: 'rgba(123,92,240,0.22)' },
      lava: { bg: '#1b0a00', win: '#ffe5d4', head: '#ff3b1f', task: '#ffb38a', icon: 'rgba(255,59,31,0.2)' },
      mint: { bg: '#0f2a2a', win: '#e3fff5', head: '#34c08a', task: '#b6f0d8', icon: 'rgba(52,192,138,0.22)' },
    };

    function applyTheme(name) {
      const t = themes[name];
      if (!t) return;
      document.documentElement.style.setProperty('--bg-color', t.bg);
      document.documentElement.style.setProperty('--win-bg', t.win);
      document.documentElement.style.setProperty('--win-header', t.head);
      document.documentElement.style.setProperty('--taskbar', t.task);
      document.documentElement.style.setProperty('--icon-hover', t.icon);
      blip(700);
    }

    function openApp(id) {
      blip();
      switch (id) {
        case 'sys':
          createWindow('SYSTEM INFO', `
            <p>8BitOS v1.2</p>
            <p>CPU: 8 MHz (virtual)</p>
            <p>RAM: 64 KB</p>
            <p>Storage: /gallery mounted</p>
            <p>Status: ONLINE</p>
          `, 320, 230);
          break;
        case 'notes':
          createWindow('NOTEPAD.TXT', `
            <textarea class="app-notes" aria-label="notes">Type your retro notes here...</textarea>
          `, 360, 260);
          break;
      case 'paint':
        const paintWin = createWindow('PAINT.EXE', `
          <div class="paint-toolbar">
            <label>Color <input type="color" id="paint-color" value="#000000"></label>
            <label>Size <input type="range" id="paint-size" min="1" max="20" value="4"></label>
            <label>Tool 
              <select id="paint-tool">
                <option value="brush">Brush</option>
                <option value="line">Line</option>
                <option value="rect">Rect</option>
                <option value="fill">Fill</option>
              </select>
            </label>
            <button id="paint-grid">Grid</button>
            <button id="paint-clear">Clear</button>
            <button id="paint-save">Save PNG</button>
          </div>
          <canvas id="paint-canvas" width="520" height="320"></canvas>
        `, 620, 480);
        setupPaint(paintWin.querySelector('#paint-canvas'));
        break;
        case 'todo':
          createWindow('TODO.LST', `
            <p>Tasks</p>
            <div id="todo-list"></div>
            <input id="todo-input" placeholder="Add item" style="width:100%;padding:6px;border:2px inset #d0d0d0;font-family:inherit;font-size:11px;">
          `, 320, 280);
          (() => {
            const win = desktop.lastElementChild;
            const list = win.querySelector('#todo-list');
            const input = win.querySelector('#todo-input');
            const render = () => list.innerHTML = todos.map((t,i)=>`<div><input type="checkbox" data-i="${i}" ${t.done?'checked':''}> ${t.text}</div>`).join('');
            const todos = [];
            input.addEventListener('keydown', e => {
              if (e.key === 'Enter' && input.value.trim()) {
                todos.push({ text: input.value.trim(), done:false });
                input.value='';
                render();
              }
            });
            list.addEventListener('change', e => {
              const i = e.target.dataset.i;
              todos[i].done = e.target.checked;
            });
            render();
          })();
          break;
        case 'clock':
          createWindow('CLOCK', `<p style="font-size:24px;text-align:center;" id="clock-live">${clockEl.textContent}</p>`, 240, 180);
          setInterval(() => {
            const el = document.getElementById('clock-live');
            if (el) el.textContent = new Date().toLocaleTimeString();
          }, 1000);
          break;
        case 'browser':
          createWindow('BROWSER', `
            <input id="mini-url" placeholder="Enter URL" style="width:100%;padding:6px;border:2px inset #d0d0d0;font-family:inherit;font-size:11px;">
            <iframe id="mini-frame" style="width:100%;height:200px;border:2px solid #000;background:#fff;"></iframe>
          `, 420, 320);
          (()=>{const w=desktop.lastElementChild;const url=w.querySelector('#mini-url');const f=w.querySelector('#mini-frame');url.addEventListener('keydown',e=>{if(e.key==='Enter'){f.src=url.value;}});})();
          break;
        case 'html-edit':
          createWindow('HTML EDITOR', `
            <textarea id="html-editor" style="width:100%;height:220px;font-family:monospace;font-size:11px;border:2px inset #d0d0d0;"></textarea>
            <button id="html-editor-copy">Copy</button>
          `, 420, 320);
          (()=>{const w=desktop.lastElementChild;w.querySelector('#html-editor-copy').onclick=()=>{const t=w.querySelector('#html-editor');t.select();document.execCommand('copy');blip(900);};})();
          break;
        case 'html-preview':
          createWindow('HTML PREVIEW', `
            <textarea id="html-src" style="width:100%;height:120px;font-family:monospace;font-size:11px;border:2px inset #d0d0d0;" placeholder="Paste HTML here"></textarea>
            <button id="html-run">Render</button>
            <div id="html-target" style="border:2px solid #000;background:#fff;height:140px;overflow:auto;margin-top:6px;padding:6px;"></div>
          `, 420, 360);
          (()=>{const w=desktop.lastElementChild;const src=w.querySelector('#html-src');const tgt=w.querySelector('#html-target');w.querySelector('#html-run').onclick=()=>{tgt.innerHTML=src.value;};})();
          break;
        case 'terminal':
          createWindow('TERMINAL', `<div id="term-log" style="height:200px;overflow:auto;background:#000;color:#33ff00;padding:6px;font-size:11px;"></div><input id="term-input" style="width:100%;padding:6px;border:2px inset #d0d0d0;background:#111;color:#33ff00;font-family:monospace;">`, 420, 320);
          (()=>{const w=desktop.lastElementChild;const log=w.querySelector('#term-log');const input=w.querySelector('#term-input');const add=t=>{const d=document.createElement('div');d.textContent=t;log.appendChild(d);log.scrollTop=log.scrollHeight;};add('echo welcome to 8Bit shell');input.addEventListener('keydown',e=>{if(e.key==='Enter'){add('> '+input.value);add('output: '+input.value.toUpperCase());input.value='';}});})();
          break;
        case 'weather':
          createWindow('WEATHER', `<p>Weather (offline)</p><p>üå§Ô∏è 72¬∞F</p><p>Sunny and bright!</p>`, 240, 200);
          break;
        case 'email':
          createWindow('EMAIL', `<p>Inbox (demo)</p><ul><li>Welcome to 8Bit Mail</li><li>Reminder: Stay retro!</li></ul>`, 260, 220);
          break;
        case 'chat':
          createWindow('CHAT', `<div id="chat-log" style="height:180px;overflow:auto;border:2px inset #d0d0d0;background:#fff;padding:4px;font-size:11px;"></div><input id="chat-input" placeholder="Type" style="width:100%;padding:6px;border:2px inset #d0d0d0;">`, 320, 260);
          (()=>{const w=desktop.lastElementChild;const log=w.querySelector('#chat-log');const input=w.querySelector('#chat-input');const add=(t)=>{const d=document.createElement('div');d.textContent=t;log.appendChild(d);log.scrollTop=log.scrollHeight;};input.addEventListener('keydown',e=>{if(e.key==='Enter'&&input.value.trim()){add('You: '+input.value.trim());add('BOT: beep boop');input.value='';}});})();
          break;
        case 'game':
          createWindow('SNAKE', `<canvas id="snake" width="280" height="200" style="border:2px solid #000;background:#fff;"></canvas><p>Arrows to move</p>`, 320, 300);
          (()=>{const w=desktop.lastElementChild;const c=w.querySelector('#snake');const ctx=c.getContext('2d');let dir='right';let snake=[[4,2],[3,2],[2,2]];let food=[6,6];const size=10;const tick=()=>{const head=[...snake[0]];if(dir==='right')head[0]++;if(dir==='left')head[0]--;if(dir==='up')head[1]--;if(dir==='down')head[1]++;if(head[0]<0||head[1]<0||head[0]*size>=c.width||head[1]*size>=c.height||snake.some(s=>s[0]===head[0]&&s[1]===head[1])){ctx.fillStyle='red';ctx.fillRect(0,0,c.width,c.height);return;}snake.unshift(head);if(head[0]===food[0]&&head[1]===food[1]){food=[Math.floor(Math.random()* (c.width/size)),Math.floor(Math.random()* (c.height/size))];}else{snake.pop();}ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#000';snake.forEach(s=>ctx.fillRect(s[0]*size,s[1]*size,size,size));ctx.fillStyle='green';ctx.fillRect(food[0]*size,food[1]*size,size,size);};setInterval(tick,120);window.addEventListener('keydown',e=>{if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){dir={ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right'}[e.key];}});})();break;
        case 'mines':
          createWindow('MINES', `<p>Mini minesweeper</p><p>üí£üí£üí£ (demo)</p>`, 220, 180);
          break;
        case 'synth':
          createWindow('SYNTH', `<p>Click keys</p><div id="synth-keys">${[261,293,329,349,392,440,493,523].map(f=>`<button data-f="${f}">${Math.round(f)}hz</button>`).join('')}</div>`, 340, 220);
          (()=>{const w=desktop.lastElementChild;w.querySelectorAll('#synth-keys button').forEach(btn=>btn.addEventListener('click',()=>{blip(parseInt(btn.dataset.f,10));}));})();
          break;
        case 'timer':
          createWindow('TIMER', `<p><input id="timer-sec" type="number" value="5" style="width:80px;"> sec</p><button id="timer-start">Start</button><div id="timer-out"></div>`, 220, 180);
          (()=>{const w=desktop.lastElementChild;const out=w.querySelector('#timer-out');w.querySelector('#timer-start').onclick=()=>{let n=parseInt(w.querySelector('#timer-sec').value,10)||0;out.textContent='...';const iv=setInterval(()=>{out.textContent=n+'s';n--;if(n<0){clearInterval(iv);out.textContent='done';blip(900);}},1000);};})();
          break;
        case 'converter':
          createWindow('CONVERTER', `<p>Inches <input id="conv-in" type="number" value="1" style="width:80px;"> = <span id="conv-cm">2.54</span> cm</p>`, 260, 140);
          (()=>{const w=desktop.lastElementChild;const cm=w.querySelector('#conv-cm');const inp=w.querySelector('#conv-in');const calc=()=>{cm.textContent=(parseFloat(inp.value||0)*2.54).toFixed(2);};inp.addEventListener('input',calc);calc();})();
          break;
        case 'calendar':
          createWindow('CALENDAR', `<p>${new Date().toDateString()}</p>`, 220, 140);
          break;
        case 'files':
          createWindow('FILES', `<ul><li>home/</li><li>games/</li><li>music/</li></ul>`, 220, 180);
          break;
        case 'reader':
          createWindow('READER', `<textarea style="width:100%;height:200px;border:2px inset #d0d0d0;">Paste text to read</textarea>`, 320, 260);
          break;
        case 'music-mp3':
          createWindow('MP3 DECK', `<p>Load your track URL</p><input id="mp3-url" placeholder="https://..." style="width:100%;padding:6px;border:2px inset #d0d0d0;"><audio id="mp3-aud" controls style="width:100%;margin-top:6px;"></audio>`, 320, 220);
          (()=>{const w=desktop.lastElementChild;const aud=w.querySelector('#mp3-aud');const url=w.querySelector('#mp3-url');url.addEventListener('keydown',e=>{if(e.key==='Enter'){aud.src=url.value;aud.play();}});})();
          break;
        case 'pixelpad':
          createWindow('PIXELPAD', `<p>Draw 8x8</p><div id="pixel-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:2px;width:160px;"></div>`, 240, 260);
          (()=>{const w=desktop.lastElementChild;const grid=w.querySelector('#pixel-grid');for(let i=0;i<64;i++){const d=document.createElement('div');d.style.border='1px solid #000';d.style.background='#fff';d.style.height='18px';d.addEventListener('click',()=>{d.style.background=d.style.background==='#fff'?'#000':'#fff';});grid.appendChild(d);}})();
          break;
        case 'news':
          createWindow('NEWS', `<ul><li>8BitOS reaches v1.3</li><li>New apps deployed</li></ul>`, 260, 180);
          break;
        case 'camera':
          createWindow('CAMERA', `<p>Camera not connected</p>`, 220, 150);
          break;
        case 'radio':
          createWindow('RADIO', `<p>Play stream</p><audio controls src=""></audio>`, 220, 160);
          break;
        case 'gallery':
          const images = [
            'https://dummyimage.com/320x200/ffffff/000000&text=Retro+1',
            'https://dummyimage.com/320x200/d4d4d4/000000&text=Retro+2',
            'https://dummyimage.com/320x200/000000/ffffff&text=Retro+3',
            'https://dummyimage.com/320x200/f0c040/000000&text=Retro+4'
          ];
          const galleryHTML = `
            <p>Gallery Folder</p>
            <div class="gallery-grid">
              ${images.map((src, i) => `<img src="${src}" alt="Retro ${i+1}" data-src="${src}">`).join('')}
            </div>
          `;
          const gWin = createWindow('GALLERY', galleryHTML, 520, 360);
          gWin.querySelectorAll('.gallery-grid img').forEach(img => {
            img.addEventListener('click', () => {
              const src = img.dataset.src;
              const viewWin = createWindow('VIEW', `<img src="${src}" alt="preview" style="width:100%; border:2px solid #000;">`, 360, 260);
              viewWin.style.width = '360px';
            });
          });
          break;
        case 'calculator':
          const calcWin = createWindow('CALC.EXE', `
            <input id="calc-display" value="0" readonly style="width:100%;padding:8px;font-family:inherit;font-size:12px;border:2px inset #d0d0d0;margin-bottom:8px;">
            <div class="calc-grid">
              ${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(v => `<button data-val="${v}">${v}</button>`).join('')}
              <button data-val="C" style="grid-column: span 2">C</button>
              <button data-val="DEL" style="grid-column: span 2">DEL</button>
            </div>
          `, 280, 280);
          setupCalc(calcWin);
          break;
        case 'music':
          const tone = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA";
          createWindow('MUSIC', `
            <div class="music-player">
              <p>Built-in demo tone</p>
              <audio controls src="${tone}"></audio>
            </div>
          `, 300, 200);
          break;
        case 'themes':
          createWindow('THEME SWITCHER', `
            <p>Select a theme:</p>
            ${Object.keys(themes).map(t => `<span class="theme-pill" data-theme="${t}">${t.toUpperCase()}</span>`).join('')}
          `, 320, 200).querySelectorAll('.theme-pill').forEach(el => {
            el.addEventListener('click', () => applyTheme(el.dataset.theme));
          });
          break;
      }
    }

    document.querySelectorAll('.icon, #start-menu .menu-item').forEach(el => {
      el.addEventListener('dblclick', () => openApp(el.dataset.app));
      el.addEventListener('click', () => blip(520));
    });

    // --- Paint Logic ---
    function setupPaint(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      let drawing = false;
      const colorPicker = canvas.parentElement.querySelector('#paint-color');
      const sizePicker = canvas.parentElement.querySelector('#paint-size');
      const clearBtn = canvas.parentElement.querySelector('#paint-clear');
      const saveBtn = canvas.parentElement.querySelector('#paint-save');
      const toolPicker = canvas.parentElement.querySelector('#paint-tool');
      const gridBtn = canvas.parentElement.querySelector('#paint-grid');
      let startPos = null;

      function pos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x, y };
      }
      function draw(e) {
        const { x, y } = pos(e);
        if (toolPicker?.value === 'line' && startPos) {
          ctx.putImageData(snapshot, 0, 0);
          ctx.strokeStyle = colorPicker.value;
          ctx.lineWidth = parseInt(sizePicker.value, 10);
          ctx.beginPath(); ctx.moveTo(startPos.x, startPos.y); ctx.lineTo(x, y); ctx.stroke();
          return;
        }
        if (!drawing) return;
        if (toolPicker?.value === 'rect' && startPos) {
          ctx.putImageData(snapshot, 0, 0);
          ctx.fillStyle = colorPicker.value;
          ctx.fillRect(startPos.x, startPos.y, x - startPos.x, y - startPos.y);
          return;
        }
        if (toolPicker?.value === 'brush') {
          ctx.fillStyle = colorPicker.value;
          ctx.beginPath();
          ctx.arc(x, y, parseInt(sizePicker.value, 10), 0, Math.PI * 2);
          ctx.fill();
        }
      }
      let snapshot = ctx.getImageData(0,0,canvas.width,canvas.height);
      canvas.addEventListener('mousedown', e => { drawing = true; startPos = pos(e); snapshot = ctx.getImageData(0,0,canvas.width,canvas.height); if(toolPicker?.value==='brush') draw(e); });
      canvas.addEventListener('touchstart', e => { drawing = true; startPos = pos(e); snapshot = ctx.getImageData(0,0,canvas.width,canvas.height); if(toolPicker?.value==='brush') draw(e); });
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('touchmove', e => { draw(e); e.preventDefault(); }, { passive: false });
      document.addEventListener('mouseup', () => drawing = false);
      document.addEventListener('touchend', () => drawing = false);
      clearBtn.addEventListener('click', () => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      });
      gridBtn?.addEventListener('click', () => {
        canvas.classList.toggle('grid-on');
      });
      canvas.addEventListener('mouseup', e => {
        if (!startPos) return;
        if (toolPicker?.value === 'line') {
          const { x, y } = pos(e);
          ctx.putImageData(snapshot,0,0);
          ctx.strokeStyle = colorPicker.value;
          ctx.lineWidth = parseInt(sizePicker.value, 10);
          ctx.beginPath(); ctx.moveTo(startPos.x, startPos.y); ctx.lineTo(x, y); ctx.stroke();
        }
        if (toolPicker?.value === 'fill') {
          const { x, y } = pos(e);
          floodFill(ctx, Math.round(x), Math.round(y), colorPicker.value);
        }
        drawing = false; startPos=null;
      });
      saveBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = '8bit-paint.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function floodFill(ctx, x, y, fillColor) {
      const img = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
      const data = img.data;
      const width = img.width;
      const idx = (x + y * width) * 4;
      const target = data.slice(idx, idx + 4);
      const fill = hexToRgba(fillColor);
      if (target.every((v, i) => v === fill[i])) return;
      const stack = [[x, y]];
      while (stack.length) {
        const [cx, cy] = stack.pop();
        if (cx < 0 || cy < 0 || cx >= width || cy >= img.height) continue;
        const i = (cx + cy * width) * 4;
        if (data[i] === target[0] && data[i + 1] === target[1] && data[i + 2] === target[2] && data[i + 3] === target[3]) {
          data[i] = fill[0]; data[i + 1] = fill[1]; data[i + 2] = fill[2]; data[i + 3] = fill[3];
          stack.push([cx + 1, cy], [cx - 1, cy], [cx, cy + 1], [cx, cy - 1]);
        }
      }
      ctx.putImageData(img, 0, 0);
    }

    function hexToRgba(hex) {
      const v = hex.replace('#', '');
      const bigint = parseInt(v, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return [r, g, b, 255];
    }

    // --- Calculator ---
    function setupCalc(win) {
      const display = win.querySelector('#calc-display');
      function input(val) {
        if (val === 'C') { display.value = '0'; return; }
        if (val === 'DEL') { display.value = display.value.slice(0, -1) || '0'; return; }
        if (val === '=') {
          try { display.value = eval(display.value) || '0'; }
          catch { display.value = 'Err'; }
          return;
        }
        display.value = display.value === '0' ? val : display.value + val;
      }
      win.querySelectorAll('.calc-grid button').forEach(btn => {
        btn.addEventListener('click', () => input(btn.dataset.val));
      });
    }

    // --- Init ---
    window.onload = runBoot;
  </script>
</body>
</html>
