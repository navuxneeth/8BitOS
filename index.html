<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>8BitOS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #2b0f54;
      --win-bg: #c2c3c7;
      --win-header: #001a6e;
      --text: #000;
      --accent: #ffcc00;
      --icon-hover: rgba(255, 255, 255, 0.15);
      --taskbar: #d0d0d0;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Press Start 2P', cursive;
      overflow: hidden;
      height: 100vh;
      cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAPCAYAAADJViUEAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVR4nO2RsQ3CMAhFX3YgB0AHYAViBXqDXIDcAFHkEzgEagdxAbFgTI1lQpOxLbaOunf7Oe+XwhFKa4zmpRmJmdBW6efcCs5DBY+1+ChDs0M1MP5s4uNuV5xMfgqtVZwA9AB/pEf8AmImOeQr1FKvW5Hv+g56oS+3oTloU+P0LLKSSp0ZCEUj3FxBHL3hG57g0lcrP6jVJsHkCKCUH54Tju/7Qe1iIzAOAAAAAElFTkSuQmCC') 0 0, auto;
    }

    .scanlines {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%),
        linear-gradient(90deg, rgba(255,0,0,0.05), rgba(0,255,0,0.05), rgba(0,0,255,0.05));
      background-size: 100% 4px, 6px 100%;
      z-index: 1200;
      mix-blend-mode: multiply;
      opacity: 0.6;
    }

    /* Preloader / Boot */
    #preloader {
      position: fixed;
      inset: 0;
      background: #000;
      color: #33ff00;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 16px;
      z-index: 1300;
      padding: 24px;
    }

    #preloader .logo {
      font-size: 18px;
      text-shadow: 0 0 8px #33ff00;
    }

    #progress-wrap {
      width: min(420px, 90vw);
      border: 2px solid #33ff00;
      padding: 4px;
    }

    #progress-bar {
      height: 14px;
      background: #104d00;
      width: 0%;
      transition: width 0.2s linear;
    }

    #boot-log {
      width: min(500px, 94vw);
      max-height: 220px;
      overflow: auto;
      background: #050505;
      border: 1px solid #104d00;
      padding: 8px;
      font-size: 11px;
      line-height: 1.6;
    }

    /* Desktop */
    #desktop {
      display: none;
      position: relative;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      background-image: radial-gradient(#442166 1px, transparent 1px);
      background-size: 6px 6px;
      overflow: hidden;
      padding-bottom: 44px;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
      gap: 12px;
      padding: 16px;
      max-width: 1280px;
    }

    .icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .icon:hover {
      background: var(--icon-hover);
      transform: translateY(-2px);
    }

    .icon-img {
      width: 54px;
      height: 54px;
      background: #fff;
      border: 2px solid #000;
      box-shadow: 4px 4px 0 #000;
      display: grid;
      place-items: center;
      font-size: 22px;
      color: #000;
      image-rendering: pixelated;
    }

    .icon-label {
      font-size: 10px;
      text-align: center;
      padding: 4px 6px;
      background: rgba(0,0,0,0.6);
      border-radius: 6px;
      width: 100%;
    }

    /* Windows */
    .window {
      position: absolute;
      background: var(--win-bg);
      border: 2px solid #000;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.45);
      min-width: 280px;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .title-bar {
      background: var(--win-header);
      color: #fff;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      font-size: 12px;
    }

    .title-bar-controls {
      display: flex;
      gap: 4px;
    }

    .title-bar-controls button {
      width: 22px;
      height: 22px;
      border: 2px solid #fff;
      border-bottom-color: #404040;
      border-right-color: #404040;
      background: var(--win-bg);
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }

    .title-bar-controls button:active {
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
    }

    .window-content {
      padding: 12px;
      font-size: 12px;
      color: var(--text);
      background: var(--win-bg);
      flex: 1;
      overflow: auto;
    }

    /* Taskbar */
    #taskbar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 44px;
      background: var(--taskbar);
      border-top: 2px solid #fff;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 6px;
      z-index: 1100;
    }

    #start-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 12px;
      background: var(--win-bg);
      border: 2px solid #fff;
      border-bottom-color: #404040;
      border-right-color: #404040;
      cursor: pointer;
    }

    #start-btn:active {
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
      background: #d4d4d4;
    }

    #clock {
      margin-left: auto;
      font-size: 11px;
      padding: 6px 12px;
      border: 2px solid #404040;
      border-bottom-color: #fff;
      border-right-color: #fff;
      background: #a0a0a0;
    }

    #start-menu {
      position: absolute;
      bottom: 48px;
      left: 6px;
      width: 220px;
      background: var(--win-bg);
      border: 2px solid #000;
      box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
      display: none;
      padding: 8px;
      z-index: 1150;
    }

    #start-menu h4 {
      margin: 4px 0 10px 0;
      font-size: 12px;
    }

    #start-menu .menu-item {
      font-size: 11px;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: #fff;
      border: 2px solid #000;
      cursor: pointer;
    }

    #start-menu .menu-item:hover { background: #d4d4d4; }

    /* Apps */
    textarea.app-notes {
      width: 100%;
      height: 220px;
      font-family: inherit;
      font-size: 11px;
      background: #fff;
      border: 2px inset #d0d0d0;
      resize: vertical;
    }

    .paint-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #paint-canvas {
      border: 2px solid #000;
      background: #fff;
      image-rendering: pixelated;
      width: 100%;
      max-width: 520px;
      height: 320px;
      touch-action: none;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }

    .gallery-grid img {
      width: 100%;
      border: 2px solid #000;
      image-rendering: pixelated;
      cursor: pointer;
      background: #fff;
    }

    .theme-pill {
      display: inline-block;
      padding: 6px 8px;
      margin: 4px;
      border: 2px solid #000;
      cursor: pointer;
      background: #fff;
      font-size: 10px;
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .calc-grid button {
      padding: 10px;
      font-family: inherit;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
    }

    .music-player audio { width: 100%; }

    @media (max-width: 700px) {
      .window {
        width: 90vw !important;
        left: 5vw !important;
        top: 10vh !important;
      }
      #desktop { padding-bottom: 52px; }
      #taskbar { height: 52px; }
      .icon-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); }
      .icon-img { width: 48px; height: 48px; }
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>

  <div id="preloader">
    <div class="logo">8BitOS Bootloader</div>
    <div id="progress-wrap"><div id="progress-bar"></div></div>
    <div id="boot-status">Loading core services...</div>
    <div id="boot-log"></div>
  </div>

  <div id="desktop">
    <div class="icon-grid">
      <div class="icon" data-app="sys">
        <div class="icon-img">?</div>
        <div class="icon-label">SYSTEM</div>
      </div>
      <div class="icon" data-app="notes">
        <div class="icon-img">A</div>
        <div class="icon-label">NOTES</div>
      </div>
      <div class="icon" data-app="paint">
        <div class="icon-img">üé®</div>
        <div class="icon-label">PAINT</div>
      </div>
      <div class="icon" data-app="gallery">
        <div class="icon-img">üñºÔ∏è</div>
        <div class="icon-label">GALLERY</div>
      </div>
      <div class="icon" data-app="calculator">
        <div class="icon-img">Ôºã</div>
        <div class="icon-label">CALC</div>
      </div>
      <div class="icon" data-app="music">
        <div class="icon-img">‚ô™</div>
        <div class="icon-label">MUSIC</div>
      </div>
      <div class="icon" data-app="themes">
        <div class="icon-img">‚öôÔ∏è</div>
        <div class="icon-label">THEMES</div>
      </div>
    </div>

    <div id="taskbar">
      <button id="start-btn"><span style="color:red">8</span><span>Bit</span></button>
      <div id="clock">00:00</div>
    </div>

    <div id="start-menu">
      <h4>Applications</h4>
      <div class="menu-item" data-app="sys">System Info</div>
      <div class="menu-item" data-app="notes">Notepad</div>
      <div class="menu-item" data-app="paint">MS Paint Clone</div>
      <div class="menu-item" data-app="gallery">Gallery Folder</div>
      <div class="menu-item" data-app="calculator">Calculator</div>
      <div class="menu-item" data-app="music">Music Player</div>
      <div class="menu-item" data-app="themes">Theme Switcher</div>
    </div>
  </div>

  <script>
    const desktop = document.getElementById('desktop');
    const startBtn = document.getElementById('start-btn');
    const startMenu = document.getElementById('start-menu');
    const clockEl = document.getElementById('clock');
    let zIndexTop = 200;

    // --- Audio ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function blip(freq = 640) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = freq;
      gain.gain.value = 0.05;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      setTimeout(() => { osc.stop(); }, 120);
    }

    // --- Bootloader ---
    const bootSteps = [
      'Initializing 8Bit Kernel...',
      'Checking memory banks...',
      'Mounting /gallery drive...',
      'Loading desktop assets...',
      'Preparing audio subsystem...',
      'Starting window manager...',
      'Finalizing...'
    ];

    function runBoot() {
      const bar = document.getElementById('progress-bar');
      const log = document.getElementById('boot-log');
      const status = document.getElementById('boot-status');
      let progress = 0;
      let step = 0;

      const timer = setInterval(() => {
        progress += Math.random() * 18;
        bar.style.width = Math.min(progress, 100) + '%';
        if (step < bootSteps.length) {
          const row = document.createElement('div');
          row.textContent = '> ' + bootSteps[step];
          log.appendChild(row);
          log.scrollTop = log.scrollHeight;
          status.textContent = bootSteps[step];
          blip(520 + step * 30);
          step++;
        }
        if (progress >= 100) {
          clearInterval(timer);
          setTimeout(() => {
            document.getElementById('preloader').style.display = 'none';
            desktop.style.display = 'block';
            blip(880);
          }, 400);
        }
      }, 320);
    }

    // --- Clock ---
    function tickClock() {
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(tickClock, 1000);
    tickClock();

    // --- Start Menu ---
    startBtn.addEventListener('click', () => {
      blip();
      startMenu.style.display = startMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!startMenu.contains(e.target) && e.target !== startBtn) {
        startMenu.style.display = 'none';
      }
    });

    // --- Window Manager ---
    function createWindow(title, contentHTML, width = 360, height = 260) {
      const win = document.createElement('div');
      win.className = 'window';
      win.style.width = width + 'px';
      win.style.height = height + 'px';
      win.style.left = (40 + Math.random() * 120) + 'px';
      win.style.top = (40 + Math.random() * 70) + 'px';
      win.style.zIndex = ++zIndexTop;
      win.innerHTML = `
        <div class="title-bar" onmousedown="dragStart(event, this.parentNode)">
          <span>${title}</span>
          <div class="title-bar-controls">
            <button aria-label="minimize">_</button>
            <button aria-label="close" onclick="this.closest('.window').remove()">X</button>
          </div>
        </div>
        <div class="window-content">${contentHTML}</div>
      `;
      win.addEventListener('mousedown', () => win.style.zIndex = ++zIndexTop);
      desktop.appendChild(win);
      return win;
    }

    // --- Dragging ---
    let dragWin = null;
    let offsetX = 0, offsetY = 0;
    function dragStart(e, win) {
      dragWin = win;
      offsetX = e.clientX - win.offsetLeft;
      offsetY = e.clientY - win.offsetTop;
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('mouseup', dragEnd);
    }
    function dragMove(e) {
      if (!dragWin) return;
      dragWin.style.left = (e.clientX - offsetX) + 'px';
      dragWin.style.top = (e.clientY - offsetY) + 'px';
    }
    function dragEnd() {
      dragWin = null;
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);
    }
    window.dragStart = dragStart; // expose for inline handler

    // --- Apps ---
    const themes = {
      classic: { bg: '#2b0f54', win: '#c2c3c7', head: '#001a6e', task: '#d0d0d0', icon: 'rgba(255,255,255,0.15)' },
      neon: { bg: '#090912', win: '#0f111a', head: '#11c5ff', task: '#0c0f1a', icon: 'rgba(17,197,255,0.2)' },
      sunset: { bg: '#2d0b1a', win: '#f8d9c6', head: '#c5163a', task: '#f1c0a0', icon: 'rgba(197,22,58,0.2)' },
    };

    function applyTheme(name) {
      const t = themes[name];
      if (!t) return;
      document.documentElement.style.setProperty('--bg-color', t.bg);
      document.documentElement.style.setProperty('--win-bg', t.win);
      document.documentElement.style.setProperty('--win-header', t.head);
      document.documentElement.style.setProperty('--taskbar', t.task);
      document.documentElement.style.setProperty('--icon-hover', t.icon);
      blip(700);
    }

    function openApp(id) {
      blip();
      switch (id) {
        case 'sys':
          createWindow('SYSTEM INFO', `
            <p>8BitOS v1.2</p>
            <p>CPU: 8 MHz (virtual)</p>
            <p>RAM: 64 KB</p>
            <p>Storage: /gallery mounted</p>
            <p>Status: ONLINE</p>
          `, 320, 230);
          break;
        case 'notes':
          createWindow('NOTEPAD.TXT', `
            <textarea class="app-notes" aria-label="notes">Type your retro notes here...</textarea>
          `, 360, 260);
          break;
        case 'paint':
          const paintWin = createWindow('PAINT.EXE', `
            <div class="paint-toolbar">
              <label>Color <input type="color" id="paint-color" value="#000000"></label>
              <label>Size <input type="range" id="paint-size" min="1" max="20" value="4"></label>
              <button id="paint-clear">Clear</button>
              <button id="paint-save">Save PNG</button>
            </div>
            <canvas id="paint-canvas" width="520" height="320"></canvas>
          `, 600, 460);
          setupPaint(paintWin.querySelector('#paint-canvas'));
          break;
        case 'gallery':
          const images = [
            'https://dummyimage.com/320x200/ffffff/000000&text=Retro+1',
            'https://dummyimage.com/320x200/d4d4d4/000000&text=Retro+2',
            'https://dummyimage.com/320x200/000000/ffffff&text=Retro+3',
            'https://dummyimage.com/320x200/f0c040/000000&text=Retro+4'
          ];
          const galleryHTML = `
            <p>Gallery Folder</p>
            <div class="gallery-grid">
              ${images.map((src, i) => `<img src="${src}" alt="Retro ${i+1}" data-src="${src}">`).join('')}
            </div>
          `;
          const gWin = createWindow('GALLERY', galleryHTML, 520, 360);
          gWin.querySelectorAll('.gallery-grid img').forEach(img => {
            img.addEventListener('click', () => {
              const src = img.dataset.src;
              const viewWin = createWindow('VIEW', `<img src="${src}" alt="preview" style="width:100%; border:2px solid #000;">`, 360, 260);
              viewWin.style.width = '360px';
            });
          });
          break;
        case 'calculator':
          const calcWin = createWindow('CALC.EXE', `
            <input id="calc-display" value="0" readonly style="width:100%;padding:8px;font-family:inherit;font-size:12px;border:2px inset #d0d0d0;margin-bottom:8px;">
            <div class="calc-grid">
              ${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(v => `<button data-val="${v}">${v}</button>`).join('')}
              <button data-val="C" style="grid-column: span 2">C</button>
              <button data-val="DEL" style="grid-column: span 2">DEL</button>
            </div>
          `, 280, 280);
          setupCalc(calcWin);
          break;
        case 'music':
          const tone = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA";
          createWindow('MUSIC', `
            <div class="music-player">
              <p>Built-in demo tone</p>
              <audio controls src="${tone}"></audio>
            </div>
          `, 300, 200);
          break;
        case 'themes':
          createWindow('THEME SWITCHER', `
            <p>Select a theme:</p>
            ${Object.keys(themes).map(t => `<span class="theme-pill" data-theme="${t}">${t.toUpperCase()}</span>`).join('')}
          `, 320, 200).querySelectorAll('.theme-pill').forEach(el => {
            el.addEventListener('click', () => applyTheme(el.dataset.theme));
          });
          break;
      }
    }

    document.querySelectorAll('.icon, #start-menu .menu-item').forEach(el => {
      el.addEventListener('dblclick', () => openApp(el.dataset.app));
      el.addEventListener('click', () => blip(520));
    });

    // --- Paint Logic ---
    function setupPaint(canvas) {
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      let drawing = false;
      const colorPicker = canvas.parentElement.querySelector('#paint-color');
      const sizePicker = canvas.parentElement.querySelector('#paint-size');
      const clearBtn = canvas.parentElement.querySelector('#paint-clear');
      const saveBtn = canvas.parentElement.querySelector('#paint-save');

      function pos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x, y };
      }
      function draw(e) {
        if (!drawing) return;
        const { x, y } = pos(e);
        ctx.fillStyle = colorPicker.value;
        ctx.beginPath();
        ctx.arc(x, y, parseInt(sizePicker.value, 10), 0, Math.PI * 2);
        ctx.fill();
      }
      canvas.addEventListener('mousedown', e => { drawing = true; draw(e); });
      canvas.addEventListener('touchstart', e => { drawing = true; draw(e); });
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('touchmove', e => { draw(e); e.preventDefault(); }, { passive: false });
      document.addEventListener('mouseup', () => drawing = false);
      document.addEventListener('touchend', () => drawing = false);
      clearBtn.addEventListener('click', () => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      });
      saveBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = '8bit-paint.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    // --- Calculator ---
    function setupCalc(win) {
      const display = win.querySelector('#calc-display');
      function input(val) {
        if (val === 'C') { display.value = '0'; return; }
        if (val === 'DEL') { display.value = display.value.slice(0, -1) || '0'; return; }
        if (val === '=') {
          try { display.value = eval(display.value) || '0'; }
          catch { display.value = 'Err'; }
          return;
        }
        display.value = display.value === '0' ? val : display.value + val;
      }
      win.querySelectorAll('.calc-grid button').forEach(btn => {
        btn.addEventListener('click', () => input(btn.dataset.val));
      });
    }

    // --- Init ---
    window.onload = runBoot;
  </script>
</body>
</html>
